# QQ AI ChatBot 产品需求文档 (PRD)

**文档版本**: v1.0  
**编写日期**: 2025-12-22  
**产品名称**: QQ AI ChatBot  
**产品类型**: 智能聊天机器人系统

---

## 目录

1. [产品概述](#1-产品概述)
2. [产品目标](#2-产品目标)
3. [用户角色](#3-用户角色)
4. [功能需求](#4-功能需求)
5. [非功能需求](#5-非功能需求)
6. [技术架构](#6-技术架构)
7. [业务流程](#7-业务流程)
8. [界面设计](#8-界面设计)
9. [数据模型](#9-数据模型)
10. [API 设计](#10-api-设计)
11. [部署方案](#11-部署方案)
12. [安全需求](#12-安全需求)
13. [性能指标](#13-性能指标)
14. [风险评估](#14-风险评估)
15. [项目计划](#15-项目计划)

---

## 1. 产品概述

### 1.1 产品简介

QQ AI ChatBot 是一款基于 NapCat（QQ 协议端）和 OpenAI/DeepSeek 大语言模型的智能聊天机器人系统。该系统通过 WebSocket 协议与 NapCat 连接，实现 QQ 私聊场景下的智能对话功能，并提供完整的 Web 管理后台用于配置管理、数据统计和聊天记录查看。

### 1.2 核心价值

- **智能化对话**: 基于 GPT-3.5/4 或 DeepSeek 等大语言模型，提供自然流畅的中文对话体验
- **多人格系统**: 支持创建多个 AI 人格，用户可通过指令切换不同的人格角色
- **上下文记忆**: 支持连续对话，智能压缩长对话历史以节省 Token 消耗
- **可视化管理**: 提供完整的 Web 管理后台，支持配置管理、数据统计、聊天记录查看
- **灵活部署**: 支持本地部署和云服务器部署，提供一键部署脚本

### 1.3 产品定位

- **目标用户**: 
  - 个人开发者、技术爱好者
  - 小型团队、社区管理员
  - 需要 QQ 机器人服务的组织
- **应用场景**:
  - QQ 私聊智能助手
  - 客服机器人
  - 知识问答系统
  - 娱乐聊天机器人

---

## 2. 产品目标

### 2.1 业务目标

1. **提升用户体验**: 提供流畅、智能的 QQ 聊天机器人服务
2. **降低使用门槛**: 提供一键部署方案，简化安装配置流程
3. **提高可维护性**: 提供完整的 Web 管理后台，便于配置和监控
4. **降低成本**: 通过智能压缩对话历史，优化 Token 消耗

### 2.2 技术目标

1. **高可用性**: 系统稳定运行，支持 7×24 小时服务
2. **高性能**: 响应时间 < 3 秒（不含 AI 生成时间）
3. **可扩展性**: 支持多模型切换，易于扩展新的 AI 服务商
4. **安全性**: 完善的认证授权机制，保护用户数据安全

---

## 3. 用户角色

### 3.1 系统管理员

**角色描述**: 负责系统配置、监控和维护的管理人员

**权限范围**:
- 登录管理后台
- 配置 AI 模型参数（提供商、模型、API Key 等）
- 管理 AI 人格（创建、编辑、删除、排序）
- 查看系统统计数据
- 查看所有用户的聊天记录
- 修改管理员账号密码

**使用场景**:
- 初始系统配置
- 定期查看系统运行状态
- 调整 AI 模型参数以优化性能
- 管理 AI 人格库

### 3.2 终端用户（QQ 用户）

**角色描述**: 通过 QQ 私聊与机器人交互的普通用户

**权限范围**:
- 与机器人进行私聊对话
- 使用指令切换 AI 人格
- 查看可用人格列表
- 添加新人格（通过交互式指令）

**使用场景**:
- 日常聊天对话
- 获取信息咨询
- 娱乐互动
- 切换不同人格体验

---

## 4. 功能需求

### 4.1 核心功能

#### 4.1.1 QQ 私聊对话

**功能描述**: 用户通过 QQ 私聊与机器人进行对话，机器人基于大语言模型生成回复

**功能详情**:
- 支持文本消息的接收和回复
- 支持连续对话，保持上下文记忆
- 支持长消息智能分段发送，模拟真人打字效果
- 支持对话历史智能压缩，节省 Token 消耗

**输入**: QQ 私聊文本消息  
**输出**: AI 生成的文本回复

**业务规则**:
- 仅处理私聊消息，忽略群聊消息
- 支持指令和普通对话两种模式
- 对话历史超过阈值时自动压缩
- 单次回复超过最大 Token 限制时截断

#### 4.1.2 多人格系统

**功能描述**: 支持创建多个 AI 人格，每个 personality 具有不同的提示词和行为特点

**功能详情**:
- 系统管理员可在后台创建、编辑、删除人格
- 每个人格包含：昵称、提示词、序号、默认标识
- 用户可通过指令切换人格
- 支持设置默认人格（新用户首次对话使用）

**业务规则**:
- 人格序号决定显示顺序
- 同一时间只能有一个默认人格
- 切换人格时清空当前对话历史
- 支持通过交互式指令添加新人格

#### 4.1.3 指令系统

**功能描述**: 提供一系列指令供用户控制机器人行为

**指令列表**:

| 指令 | 说明 | 示例 | 权限 |
|------|------|------|------|
| `/help` | 显示帮助列表 | `/help` | 所有用户 |
| `/new` | 清空对话，开始新会话 | `/new` | 所有用户 |
| `/person <序号>` | 切换到指定人格 | `/person 2` | 所有用户 |
| `/person_ls` | 查看可用人格列表 | `/person_ls` | 所有用户 |
| `/add` | 添加新人格（交互式） | `/add` | 所有用户 |

**业务规则**:
- 指令以 `/` 开头，不区分大小写
- 指令执行后返回相应结果
- `/add` 指令为多步交互流程（昵称 → 提示词）

#### 4.1.4 对话历史管理

**功能描述**: 智能管理对话历史，平衡上下文记忆和 Token 消耗

**功能详情**:
- 维护每个用户的对话历史（消息列表）
- 当历史轮数超过阈值时，自动压缩早期对话
- 压缩策略：保留最近 N 轮对话，将更早的对话合并为摘要

**业务规则**:
- 默认保留最近 20 轮对话
- 压缩阈值为 10 轮（可配置）
- 压缩后的摘要包含关键信息，不影响后续对话质量

### 4.2 管理后台功能

#### 4.2.1 登录认证

**功能描述**: 管理员通过用户名密码登录管理后台

**功能详情**:
- 登录表单验证（用户名、密码）
- JWT Token 认证机制
- Token 有效期 7 天
- 登录失败次数限制（15 分钟内最多 5 次）

**安全规则**:
- 密码使用 bcrypt 加密存储
- Token 存储在 localStorage 和 Cookie
- 未登录用户自动跳转到登录页

#### 4.2.2 仪表盘

**功能描述**: 展示系统运行状态和统计数据

**功能模块**:
1. **系统状态**
   - 机器人在线/离线状态
   - NapCat 连接状态

2. **消息统计**
   - 总消息数
   - 今日消息数
   - 活跃用户数

3. **Token 消耗统计**
   - 总 Token 消耗
   - 今日 Token 消耗
   - 近 7 天 Token 消耗趋势图

4. **消息量趋势**
   - 近 7 天消息量折线图

5. **模型使用统计**
   - 各模型使用次数饼图

6. **用户排行榜**
   - 消息数 Top 10
   - Token 消耗 Top 10

**数据更新**: 实时刷新（每 5 秒）

#### 4.2.3 配置管理

**功能描述**: 管理系统配置参数

**配置项**:

| 配置项 | 说明 | 类型 | 默认值 | 范围 |
|--------|------|------|--------|------|
| 模型提供商 | OpenAI / DeepSeek | 枚举 | openai | - |
| 模型 | GPT-3.5-Turbo / GPT-4 等 | 字符串 | gpt-3.5-turbo | - |
| API Key | 大模型 API 密钥 | 字符串 | - | - |
| Base URL | API 基础地址 | URL | https://api.openai.com/v1 | - |
| 最大 Token | 单次回复最大 Token 数 | 整数 | 1000 | 1-10000 |
| 温度 | 回复随机性 | 浮点数 | 0.7 | 0-2 |
| 历史轮数 | 保留的对话轮数 | 整数 | 20 | 1-100 |
| 压缩阈值 | 触发压缩的轮数 | 整数 | 10 | 1-50 |
| 全局约束提示词 | 所有人格的基础规则 | 文本 | - | 最大 1000 字符 |
| 分段发送 | 是否启用长消息分段 | 布尔 | true | - |

**功能详情**:
- 表单验证（类型、范围、格式）
- 配置保存后立即生效
- API Key 和 Base URL 同步更新到 `.env` 文件

#### 4.2.4 人格管理

**功能描述**: 管理 AI 人格库

**功能操作**:
- **创建人格**: 填写昵称、提示词、序号
- **编辑人格**: 修改昵称、提示词、序号
- **删除人格**: 删除指定人格（需确认）
- **调整顺序**: 上移/下移人格序号
- **设置默认**: 将指定人格设为默认人格

**表单字段**:
- 昵称（必填，1-50 字符）
- 提示词（必填，1-2000 字符）
- 序号（必填，正整数）

**业务规则**:
- 序号决定显示顺序，可重复但建议唯一
- 设置新默认人格时，原默认人格自动取消
- 删除人格后，其他人格序号不变

#### 4.2.5 消息记录

**功能描述**: 查看用户聊天记录

**功能模块**:
1. **用户列表**
   - 显示所有与机器人对话过的用户
   - 字段：QQ 号、昵称、消息数、Token 消耗、最后聊天时间
   - 支持按消息数、Token 消耗排序

2. **聊天详情**
   - ChatGPT 风格的对话界面
   - 显示完整的对话历史
   - 区分用户消息和 AI 回复
   - 显示每条消息的时间戳

**数据展示**:
- 分页显示用户列表
- 点击用户进入聊天详情页
- 聊天记录按时间倒序显示

### 4.3 系统功能

#### 4.3.1 WebSocket 连接管理

**功能描述**: 管理与 NapCat 的 WebSocket 连接

**功能详情**:
- 监听指定端口（默认 3001），等待 NapCat 连接
- 处理 OneBot 协议消息（事件和 API 请求）
- 连接断开时自动重连（由 NapCat 负责）
- 支持 `get_supported_actions` API 响应

**业务规则**:
- 仅支持反向 WebSocket 模式（NapCat 主动连接）
- 仅处理私聊消息事件
- 其他 API 请求返回"不支持"错误

#### 4.3.2 数据统计

**功能描述**: 自动统计系统运行数据

**统计指标**:
- 总消息数、今日消息数
- 总 Token 消耗、今日 Token 消耗
- 近 7 天消息量和 Token 消耗（按天）
- 各模型使用次数
- 用户消息数和 Token 消耗

**更新机制**:
- 每次消息处理时更新统计数据
- 每日 0 点自动重置今日数据
- 每周数据滚动更新（保留最近 7 天）

#### 4.3.3 日志系统

**功能描述**: 记录系统运行日志

**日志级别**:
- ERROR: 错误日志（写入 error.log）
- INFO: 信息日志（写入 combined.log）
- 控制台输出（开发环境）

**日志内容**:
- WebSocket 连接/断开
- 消息处理成功/失败
- API 请求和响应
- 数据库操作错误

---

## 5. 非功能需求

### 5.1 性能需求

| 指标 | 要求 | 说明 |
|------|------|------|
| API 响应时间 | < 500ms | 不含 AI 生成时间 |
| 消息处理延迟 | < 100ms | 从接收到开始处理 |
| 并发用户数 | ≥ 100 | 同时在线用户 |
| 数据库查询 | < 100ms | 单次查询响应时间 |

### 5.2 可用性需求

- **系统可用性**: ≥ 99.5%（月度）
- **故障恢复时间**: < 5 分钟
- **数据备份**: 每日自动备份 MongoDB
- **服务监控**: 提供健康检查接口

### 5.3 兼容性需求

- **Node.js**: ≥ 18.0.0
- **MongoDB**: ≥ 3.6.8（兼容 mongoose 7.6.0+）
- **浏览器**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **操作系统**: Linux（CentOS 7+, Ubuntu 18.04+）, Windows 10+, macOS 10.15+

### 5.4 可维护性需求

- **代码规范**: 遵循 ESLint/Prettier 规范
- **文档完整**: 提供 README、API 文档、部署文档
- **日志完整**: 关键操作记录日志
- **错误处理**: 完善的错误捕获和提示

### 5.5 可扩展性需求

- **模型扩展**: 易于添加新的 AI 服务商（如 Claude、Gemini）
- **功能扩展**: 模块化设计，易于添加新功能
- **存储扩展**: 支持 MongoDB 副本集和分片

---

## 6. 技术架构

### 6.1 系统架构图

```
┌─────────────┐
│   QQ 用户   │
└──────┬──────┘
       │ QQ 私聊消息
       ▼
┌─────────────────┐
│    NapCat       │  (OneBot 11 协议)
│  (QQ 协议端)    │
└──────┬──────────┘
       │ WebSocket (反向连接)
       ▼
┌─────────────────────────────────────┐
│         后端服务 (Node.js)          │
│  ┌──────────────┐  ┌──────────────┐ │
│  │ WebSocket    │  │  HTTP API    │ │
│  │ Server       │  │  Server      │ │
│  └──────┬───────┘  └──────┬───────┘ │
│         │                  │         │
│  ┌──────▼──────────────────▼───────┐ │
│  │     业务逻辑层                   │ │
│  │  - 消息处理                      │ │
│  │  - 指令解析                      │ │
│  │  - 对话管理                      │ │
│  └──────┬──────────────────┬───────┘ │
│         │                  │         │
│  ┌──────▼──────────────────▼───────┐ │
│  │     数据访问层                   │ │
│  │  - MongoDB (Mongoose)           │ │
│  └─────────────────────────────────┘ │
└─────────────────────────────────────┘
       │                  │
       ▼                  ▼
┌─────────────┐  ┌──────────────────┐
│  MongoDB    │  │  OpenAI/DeepSeek │
│  数据库     │  │  API             │
└─────────────┘  └──────────────────┘
       │
       │ HTTP API
       ▼
┌─────────────────┐
│   前端 (Vue 3)  │
│  - 管理后台     │
│  - 数据可视化   │
└─────────────────┘
       │
       │ Nginx 反向代理
       ▼
┌─────────────┐
│   浏览器    │
└─────────────┘
```

### 6.2 技术栈

#### 6.2.1 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Node.js | ≥ 18.0.0 | 运行时环境 |
| Express | 5.2.1 | HTTP API 框架 |
| WebSocket (ws) | 8.16.0 | WebSocket 服务器 |
| OpenAI SDK | 4.24.0 | 大语言模型 API 客户端 |
| Mongoose | 7.6.0 | MongoDB ODM |
| JWT | 9.0.3 | 身份认证 |
| Winston | 3.19.0 | 日志系统 |
| Joi | 18.0.2 | 输入验证 |
| express-rate-limit | 8.2.1 | 速率限制 |

#### 6.2.2 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Vue 3 | 3.5.24 | 前端框架 |
| TypeScript | 5.9.3 | 类型系统 |
| Element Plus | 2.12.0 | UI 组件库 |
| Vue Router | 4.6.4 | 路由管理 |
| Pinia | 3.0.4 | 状态管理 |
| ECharts | 6.0.0 | 数据可视化 |
| Axios | 1.13.2 | HTTP 客户端 |
| Vite | 7.2.4 | 构建工具 |

#### 6.2.3 基础设施

| 技术 | 用途 |
|------|------|
| MongoDB | 数据存储 |
| Nginx | 反向代理、静态文件服务 |
| PM2 | 进程管理 |
| NapCat | QQ 协议端（OneBot 11） |
| Docker/Podman | 容器化部署（可选） |

### 6.3 模块设计

#### 6.3.1 后端模块

1. **WebSocket 模块** (`server/index.js`)
   - 处理 NapCat 连接
   - 解析 OneBot 协议消息
   - 响应 API 请求

2. **消息处理模块** (`server/index.js`)
   - 指令解析和执行
   - 对话历史管理
   - AI 回复生成

3. **API 模块** (`server/index.js`)
   - RESTful API 路由
   - 认证中间件
   - 输入验证

4. **数据模型模块** (`server/index.js`)
   - Mongoose Schema 定义
   - 数据访问方法

#### 6.3.2 前端模块

1. **路由模块** (`src/router/index.ts`)
   - 路由配置
   - 路由守卫（认证）

2. **视图模块** (`src/views/`)
   - Login.vue: 登录页
   - Dashboard.vue: 仪表盘
   - Config.vue: 配置管理
   - Personas.vue: 人格管理
   - Records.vue: 用户列表
   - ChatDetail.vue: 聊天详情

3. **组件模块** (`src/components/`)
   - 可复用 UI 组件

---

## 7. 业务流程

### 7.1 用户对话流程

```
用户发送消息
    │
    ▼
NapCat 接收消息
    │
    ▼
通过 WebSocket 发送事件到后端
    │
    ▼
后端解析消息类型
    │
    ├─ 指令消息 ──→ 执行指令 ──→ 返回指令结果
    │
    └─ 普通消息 ──→ 获取用户会话
                │
                ▼
            加载对话历史
                │
                ▼
            调用 AI API 生成回复
                │
                ▼
            保存对话历史
                │
                ▼
            分段发送回复
                │
                ▼
            更新统计数据
```

### 7.2 管理员登录流程

```
访问管理后台
    │
    ▼
检查 Token
    │
    ├─ 有效 ──→ 进入系统
    │
    └─ 无效/不存在 ──→ 跳转登录页
                    │
                    ▼
                输入用户名密码
                    │
                    ▼
                验证凭据
                    │
                    ├─ 成功 ──→ 生成 JWT Token ──→ 进入系统
                    │
                    └─ 失败 ──→ 显示错误信息
```

### 7.3 人格切换流程

```
用户发送 /person 2
    │
    ▼
后端解析指令
    │
    ▼
查找序号为 2 的人格
    │
    ├─ 找到 ──→ 更新用户会话人格
    │           │
    │           ▼
    │        清空对话历史
    │           │
    │           ▼
    │        返回成功消息
    │
    └─ 未找到 ──→ 返回错误消息
```

### 7.4 添加人格流程（交互式）

```
用户发送 /add
    │
    ▼
后端设置用户状态为"等待昵称"
    │
    ▼
返回提示："请发送人格的昵称"
    │
    ▼
用户发送昵称
    │
    ▼
后端保存昵称，设置状态为"等待提示词"
    │
    ▼
返回提示："请发送人格的提示词"
    │
    ▼
用户发送提示词
    │
    ▼
后端创建新人格
    │
    ▼
返回成功消息（包含人格信息）
```

---

## 8. 界面设计

### 8.1 登录页

**布局**:
- 居中卡片式布局
- 标题："QQ AI ChatBot 管理后台"
- 表单字段：用户名、密码
- 登录按钮

**交互**:
- 表单验证（必填项、格式）
- 登录失败显示错误提示
- 登录成功跳转到仪表盘

### 8.2 仪表盘

**布局**:
- 顶部：系统状态卡片（在线/离线）
- 第一行：统计卡片（总消息数、今日消息数、活跃用户数、总 Token、今日 Token）
- 第二行：图表区域（左右分栏）
  - 左侧：消息量趋势图（折线图）
  - 右侧：Token 消耗趋势图（折线图）
- 第三行：模型使用统计（饼图）
- 底部：用户排行榜（表格）

**交互**:
- 自动刷新（每 5 秒）
- 图表支持缩放和悬停提示

### 8.3 配置管理

**布局**:
- 表单布局，分组显示
- 第一组：模型配置（提供商、模型、API Key、Base URL）
- 第二组：生成参数（最大 Token、温度）
- 第三组：对话优化（历史轮数、压缩阈值、全局约束提示词）
- 第四组：其他设置（分段发送开关）
- 底部：保存按钮

**交互**:
- 实时表单验证
- 保存成功显示提示
- 配置变更立即生效

### 8.4 人格管理

**布局**:
- 顶部：操作按钮（添加人格）
- 主体：人格列表（表格）
  - 列：序号、昵称、提示词（截断显示）、操作
  - 操作：编辑、删除、设为默认、上移、下移
- 弹窗：编辑/创建表单

**交互**:
- 点击"添加"打开创建弹窗
- 点击"编辑"打开编辑弹窗（预填充数据）
- 删除前确认
- 排序操作实时更新

### 8.5 消息记录

**布局**:
- 左侧：用户列表（表格）
  - 列：QQ 号、昵称、消息数、Token 消耗、最后聊天时间
  - 支持排序和分页
- 右侧：聊天详情（ChatGPT 风格）
  - 消息气泡（用户/AI 区分）
  - 时间戳显示

**交互**:
- 点击用户行加载聊天详情
- 聊天记录滚动到底部
- 支持消息搜索（未来功能）

---

## 9. 数据模型

### 9.1 数据模型设计

#### 9.1.1 Persona（人格）

```javascript
{
  _id: ObjectId,
  order: Number,          // 序号（用于排序）
  name: String,           // 昵称
  prompt: String,          // 提示词
  isDefault: Boolean,      // 是否默认人格
  createdAt: Date,        // 创建时间
  updatedAt: Date         // 更新时间
}
```

**索引**:
- `order`: 升序索引
- `isDefault`: 升序索引

#### 9.1.2 Config（配置）

```javascript
{
  _id: ObjectId,
  provider: String,        // 'openai' | 'deepseek'
  model: String,           // 模型名称
  maxTokens: Number,       // 最大 Token 数
  temperature: Number,     // 温度参数
  maxHistoryLength: Number, // 历史轮数
  summaryThreshold: Number, // 压缩阈值
  globalPrompt: String,    // 全局约束提示词
  enableStream: Boolean,   // 是否启用流式输出
  createdAt: Date,
  updatedAt: Date
}
```

**说明**: 单例模型，系统仅保留一条配置记录

#### 9.1.3 ChatUser（聊天用户）

```javascript
{
  _id: ObjectId,
  userId: String,          // QQ 号（唯一）
  nickname: String,        // 昵称
  messageCount: Number,    // 消息数
  tokenCount: Number,      // Token 消耗
  lastChatTime: Date,      // 最后聊天时间
  messages: [              // 消息历史（可选，用于详情页）
    {
      role: String,        // 'user' | 'assistant'
      content: String,      // 消息内容
      time: Date,          // 时间戳
      tokens: Number       // Token 数
    }
  ],
  createdAt: Date,
  updatedAt: Date
}
```

**索引**:
- `userId`: 唯一索引
- `lastChatTime`: 降序索引
- `messageCount`: 降序索引
- `tokenCount`: 降序索引

#### 9.1.4 Stats（统计数据）

```javascript
{
  _id: ObjectId,
  totalMessages: Number,   // 总消息数
  todayMessages: Number,   // 今日消息数
  totalTokens: Number,     // 总 Token 消耗
  todayTokens: Number,     // 今日 Token 消耗
  weeklyMessages: [Number], // 近 7 天消息量（数组，每天一个值）
  weeklyTokens: [Number],   // 近 7 天 Token 消耗
  modelUsage: Object,      // 模型使用统计 { "gpt-3.5-turbo": 120, ... }
  lastResetDate: String,   // 最后重置日期（用于每日重置）
  createdAt: Date,
  updatedAt: Date
}
```

**说明**: 单例模型，系统仅保留一条统计记录

### 9.2 数据关系

- **Persona** 与 **ChatUser**: 一对多（通过 `session.persona` 关联，内存中）
- **Config**: 独立单例
- **Stats**: 独立单例
- **ChatUser**: 独立实体

### 9.3 数据存储策略

- **对话历史**: 存储在内存 `sessions` Map 中，不持久化到数据库（节省存储）
- **用户消息**: 仅存储统计信息（消息数、Token 消耗），不存储完整消息内容
- **聊天详情**: 通过 `ChatUser.messages` 字段存储（可选，用于管理后台查看）

---

## 10. API 设计

### 10.1 RESTful API

#### 10.1.1 认证接口

**POST /api/login**
- **描述**: 管理员登录
- **请求体**:
  ```json
  {
    "username": "admin",
    "password": "admin123"
  }
  ```
- **响应**:
  ```json
  {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "username": "admin"
  }
  ```
- **错误响应**:
  ```json
  {
    "error": "用户名或密码错误"
  }
  ```

#### 10.1.2 配置接口

**GET /api/config**
- **描述**: 获取系统配置
- **认证**: 需要
- **响应**:
  ```json
  {
    "provider": "openai",
    "model": "gpt-3.5-turbo",
    "maxTokens": 1000,
    "temperature": 0.7,
    "maxHistoryLength": 20,
    "summaryThreshold": 10,
    "globalPrompt": "你必须遵守以下规则...",
    "enableStream": true
  }
  ```

**POST /api/config**
- **描述**: 更新系统配置
- **认证**: 需要
- **请求体**: 同 GET 响应（部分字段可选）
- **响应**:
  ```json
  {
    "success": true
  }
  ```

#### 10.1.3 人格接口

**GET /api/personas**
- **描述**: 获取人格列表
- **认证**: 需要
- **响应**:
  ```json
  [
    {
      "id": "507f1f77bcf86cd799439011",
      "order": 1,
      "name": "默认助手",
      "prompt": "你是一个友好的AI助手。",
      "isDefault": true
    }
  ]
  ```

**POST /api/personas**
- **描述**: 创建人格
- **认证**: 需要
- **请求体**:
  ```json
  {
    "name": "技术专家",
    "prompt": "你是一个技术专家...",
    "order": 2
  }
  ```
- **响应**: 创建的人格对象

**PUT /api/personas/:id**
- **描述**: 更新人格
- **认证**: 需要
- **请求体**: 同 POST（部分字段可选）
- **响应**:
  ```json
  {
    "success": true
  }
  ```

**DELETE /api/personas/:id**
- **描述**: 删除人格
- **认证**: 需要
- **响应**:
  ```json
  {
    "success": true
  }
  ```

**POST /api/personas/:id/default**
- **描述**: 设置默认人格
- **认证**: 需要
- **响应**:
  ```json
  {
    "success": true
  }
  ```

**POST /api/personas/swap-order**
- **描述**: 交换两个人格的序号
- **认证**: 需要
- **请求体**:
  ```json
  {
    "id1": "507f1f77bcf86cd799439011",
    "id2": "507f1f77bcf86cd799439012"
  }
  ```
- **响应**:
  ```json
  {
    "success": true
  }
  ```

#### 10.1.4 用户接口

**GET /api/users**
- **描述**: 获取用户列表
- **认证**: 需要
- **查询参数**: 
  - `page`: 页码（默认 1）
  - `limit`: 每页数量（默认 20）
  - `sort`: 排序字段（默认 `messageCount`）
- **响应**:
  ```json
  {
    "users": [
      {
        "userId": "123456789",
        "nickname": "用户A",
        "messageCount": 56,
        "tokenCount": 12300,
        "lastChatTime": "2025-12-22T10:30:00Z"
      }
    ],
    "total": 100,
    "page": 1,
    "limit": 20
  }
  ```

**GET /api/users/:userId/messages**
- **描述**: 获取用户聊天记录
- **认证**: 需要
- **响应**:
  ```json
  {
    "userId": "123456789",
    "nickname": "用户A",
    "messages": [
      {
        "role": "user",
        "content": "你好",
        "time": "2025-12-22T10:30:00Z",
        "tokens": 5
      },
      {
        "role": "assistant",
        "content": "你好！有什么可以帮助你的吗？",
        "time": "2025-12-22T10:30:05Z",
        "tokens": 15
      }
    ]
  }
  ```

#### 10.1.5 统计接口

**GET /api/stats**
- **描述**: 获取系统统计数据
- **认证**: 需要
- **响应**:
  ```json
  {
    "status": "online",
    "totalMessages": 156,
    "todayMessages": 23,
    "activeUsers": 8,
    "totalTokens": 45230,
    "todayTokens": 3200,
    "weeklyMessages": [12, 19, 15, 25, 22, 30, 23],
    "weeklyTokens": [1200, 1900, 1500, 2500, 2200, 3000, 3200],
    "modelUsage": {
      "gpt-3.5-turbo": 120,
      "gpt-4": 36
    },
    "userRanking": [
      {
        "userId": "123456",
        "nickname": "用户A",
        "messageCount": 56,
        "tokenCount": 12300
      }
    ]
  }
  ```

### 10.2 WebSocket API

#### 10.2.1 OneBot 事件

**消息事件**:
```json
{
  "post_type": "message",
  "message_type": "private",
  "user_id": 123456789,
  "raw_message": "你好",
  "message": "你好",
  "sender": {
    "nickname": "用户A"
  }
}
```

#### 10.2.2 OneBot API 请求

**get_supported_actions**:
```json
{
  "action": "get_supported_actions",
  "params": {},
  "echo": "unique-id"
}
```

**响应**:
```json
{
  "status": "ok",
  "retcode": 0,
  "data": ["send_private_msg", "get_supported_actions"],
  "echo": "unique-id"
}
```

**send_private_msg** (由后端调用):
```json
{
  "action": "send_private_msg",
  "params": {
    "user_id": 123456789,
    "message": "你好！"
  },
  "echo": "unique-id"
}
```

### 10.3 错误码

| HTTP 状态码 | 说明 |
|------------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未登录或 Token 过期 |
| 404 | 资源不存在 |
| 429 | 请求过于频繁 |
| 500 | 服务器内部错误 |

---

## 11. 部署方案

### 11.1 部署架构

```
┌─────────────────────────────────┐
│     云服务器 (Alibaba Cloud)    │
│                                 │
│  ┌───────────────────────────┐  │
│  │      Nginx (80)          │  │
│  │  - 反向代理               │  │
│  │  - 静态文件服务           │  │
│  └───────────┬───────────────┘  │
│              │                   │
│  ┌───────────▼───────────────┐  │
│  │  前端 (Vue 3)             │  │
│  │  - /var/www/bot/         │  │
│  └───────────────────────────┘  │
│                                 │
│  ┌───────────────────────────┐  │
│  │  后端 (Node.js + PM2)    │  │
│  │  - API: 3002             │  │
│  │  - WebSocket: 3003       │  │
│  └───────────┬───────────────┘  │
│              │                   │
│  ┌───────────▼───────────────┐  │
│  │  MongoDB (3.6.8)         │  │
│  │  - 端口: 27017           │  │
│  └───────────────────────────┘  │
│                                 │
│  ┌───────────────────────────┐  │
│  │  NapCat (Podman)         │  │
│  │  - WebUI: 6099           │  │
│  │  - 反向 WS: 3003         │  │
│  └───────────────────────────┘  │
└─────────────────────────────────┘
```

### 11.2 部署步骤

#### 11.2.1 自动部署（推荐）

使用提供的 `deploy.sh` 脚本一键部署：

```bash
# 在服务器上执行
curl -o deploy.sh https://raw.githubusercontent.com/diyishaoshuai/qqAiChatBot/main/deploy.sh
chmod +x deploy.sh
sudo ./deploy.sh
```

**脚本功能**:
1. 安装 Node.js 20、pnpm、pm2
2. 安装 MongoDB 3.6.8
3. 安装 Nginx、Podman
4. 克隆项目代码
5. 安装依赖并构建前端
6. 配置 Nginx
7. 启动后端服务（PM2）
8. 配置防火墙规则
9. 拉取并启动 NapCat 容器

#### 11.2.2 手动部署

1. **环境准备**
   - 安装 Node.js ≥ 18
   - 安装 MongoDB ≥ 3.6.8
   - 安装 Nginx
   - 安装 PM2

2. **代码部署**
   ```bash
   git clone https://github.com/diyishaoshuai/qqAiChatBot.git
   cd qqAiChatBot
   ```

3. **后端配置**
   ```bash
   cd server
   pnpm install
   cp env.example .env
   # 编辑 .env 文件
   ```

4. **前端构建**
   ```bash
   cd ..
   pnpm install
   pnpm build --mode production
   ```

5. **部署前端**
   ```bash
   sudo mkdir -p /var/www/bot
   sudo cp -r dist/* /var/www/bot/
   ```

6. **配置 Nginx**
   - 参考 `nginx-bot.conf` 配置

7. **启动服务**
   ```bash
   cd server
   pm2 start index.js --name qqchatbot
   pm2 save
   pm2 startup
   ```

8. **配置 NapCat**
   - 使用 Podman/Docker 运行 NapCat
   - 配置反向 WebSocket: `ws://127.0.0.1:3003`

### 11.3 环境变量配置

**server/.env**:
```env
# 大模型 API
OPENAI_API_KEY=sk-your-api-key
OPENAI_BASE_URL=https://api.openai.com/v1

# MongoDB
MONGODB_URI=mongodb://127.0.0.1:27017/qqchatbot

# 管理后台
ADMIN_USER=admin
ADMIN_PASSWORD=admin123

# JWT
JWT_SECRET=please-change-me

# 端口
WS_PORT=3003
API_PORT=3002
```

### 11.4 Nginx 配置

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    location /bot/ {
        root /var/www;
        try_files $uri $uri/ /bot/index.html;
        index index.html;
    }

    # 后端 API
    location /api/ {
        proxy_pass http://127.0.0.1:3002/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### 11.5 防火墙配置

```bash
# 开放必要端口
firewall-cmd --permanent --add-service=ssh
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --permanent --add-port=3002/tcp  # API
firewall-cmd --permanent --add-port=3003/tcp  # WebSocket
firewall-cmd --reload
```

---

## 12. 安全需求

### 12.1 认证授权

- **JWT Token**: 使用 JWT 进行身份认证，Token 有效期 7 天
- **密码加密**: 管理员密码使用 bcrypt 加密存储
- **登录限制**: 15 分钟内最多 5 次登录尝试
- **API 限流**: 1 分钟内最多 60 次 API 请求

### 12.2 数据安全

- **敏感信息**: API Key、密码等敏感信息存储在 `.env` 文件，不提交到 Git
- **输入验证**: 使用 Joi 进行输入验证，防止注入攻击
- **HTTPS**: 生产环境建议配置 HTTPS（使用 Let's Encrypt）

### 12.3 网络安全

- **防火墙**: 仅开放必要端口（80, 443, 22, 3002, 3003）
- **反向代理**: 使用 Nginx 反向代理，隐藏后端端口
- **CORS**: 配置 CORS 策略，限制跨域请求

### 12.4 日志安全

- **日志脱敏**: 敏感信息（如 API Key）不记录到日志
- **日志轮转**: 定期清理旧日志文件
- **错误处理**: 不向客户端暴露详细的错误信息

---

## 13. 性能指标

### 13.1 响应时间

| 操作 | 目标响应时间 | 说明 |
|------|------------|------|
| API 请求 | < 500ms | 不含 AI 生成时间 |
| 消息处理 | < 100ms | 从接收到开始处理 |
| 数据库查询 | < 100ms | 单次查询 |
| 前端页面加载 | < 2s | 首次加载 |

### 13.2 吞吐量

| 指标 | 目标值 |
|------|--------|
| 并发用户数 | ≥ 100 |
| 消息处理速度 | ≥ 10 条/秒 |
| API 请求 QPS | ≥ 100 |

### 13.3 资源占用

| 资源 | 预期占用 |
|------|---------|
| 内存 | < 512MB（后端） |
| CPU | < 20%（空闲时） |
| 磁盘 | < 1GB（不含日志） |

---

## 14. 风险评估

### 14.1 技术风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| NapCat 协议变更 | 高 | 低 | 关注 OneBot 协议更新，及时适配 |
| AI API 服务不稳定 | 高 | 中 | 实现重试机制，添加降级方案 |
| MongoDB 数据丢失 | 高 | 低 | 定期备份数据库，使用副本集 |
| 服务器资源不足 | 中 | 中 | 监控资源使用，及时扩容 |

### 14.2 业务风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| Token 消耗过高 | 中 | 中 | 优化对话压缩算法，设置使用上限 |
| 用户滥用 | 中 | 中 | 实现速率限制，监控异常行为 |
| 数据隐私泄露 | 高 | 低 | 加强数据加密，遵守隐私法规 |

### 14.3 运营风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| 管理员账号泄露 | 高 | 低 | 强制使用强密码，启用双因素认证（未来） |
| 服务中断 | 高 | 低 | 使用 PM2 自动重启，配置监控告警 |

---

## 15. 项目计划

### 15.1 开发阶段

#### 阶段一：核心功能开发（已完成）
- ✅ WebSocket 连接管理
- ✅ 消息处理和 AI 回复
- ✅ 指令系统
- ✅ 基础管理后台

#### 阶段二：功能完善（已完成）
- ✅ 多人格系统
- ✅ 对话历史管理
- ✅ 数据统计
- ✅ 完整管理后台

#### 阶段三：优化和部署（进行中）
- ✅ 部署脚本优化
- ✅ Nginx 配置优化
- ✅ 错误处理完善
- 🔄 性能优化（进行中）

### 15.2 未来规划

#### 短期（1-3 个月）
- [ ] 支持更多 AI 模型（Claude、Gemini）
- [ ] 群聊消息支持
- [ ] 消息搜索功能
- [ ] 导出聊天记录

#### 中期（3-6 个月）
- [ ] 多机器人实例支持
- [ ] 插件系统
- [ ] 定时任务功能
- [ ] 更丰富的数据分析

#### 长期（6-12 个月）
- [ ] 分布式部署
- [ ] 多租户支持
- [ ] API 开放平台
- [ ] 移动端 App

---

## 附录

### A. 术语表

| 术语 | 说明 |
|------|------|
| NapCat | QQ 协议端，实现 OneBot 11 协议 |
| OneBot | QQ 机器人通信协议标准 |
| Persona | AI 人格，定义 AI 的行为特点 |
| Token | 大语言模型的计费单位 |
| WebSocket | 全双工通信协议 |
| JWT | JSON Web Token，用于身份认证 |

### B. 参考文档

- [NapCat 官方文档](https://github.com/NapNeko/NapCatQQ)
- [OneBot 协议规范](https://11.onebot.dev/)
- [OpenAI API 文档](https://platform.openai.com/docs)
- [Vue 3 文档](https://vuejs.org/)
- [Mongoose 文档](https://mongoosejs.com/)

### C. 更新日志

**v1.0.0 (2025-12-22)**
- 初始 PRD 文档

---

**文档结束**

